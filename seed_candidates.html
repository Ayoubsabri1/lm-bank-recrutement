<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>G√©n√©rateur Avanc√© - LM BANK</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 600px;
            max-width: 100%;
        }

        h2 {
            color: #0056B3;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .stat-box {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .stat-val {
            font-size: 1.2rem;
            color: #0056B3;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #0056B3 0%, #00AEEF 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 86, 179, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #progress-container {
            margin-top: 25px;
            background: #e9ecef;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            display: none;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }

        .log-area {
            margin-top: 20px;
            text-align: left;
            background: #2d3436;
            color: #00D2D3;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            height: 200px;
            overflow-y: auto;
            display: none;
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 2px;
        }

        .log-success {
            color: #55E6C1;
        }

        .log-error {
            color: #ff7675;
        }

        .log-info {
            color: #74b9ff;
        }
    </style>
</head>

<body>

    <div class="card">
        <h2>‚ö° G√©n√©rateur Candidats Intelligent</h2>
        <p style="color: #6c757d;">Ce script va lire toutes vos offres actives et g√©n√©rer :</p>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-val" style="color: #28a745;">1 Match</div>
                <div class="stat-label">Parfait (Score √âlev√©)</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" style="color: #dc3545;">1 Mismatch</div>
                <div class="stat-label">Non pertinent (Score Faible)</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" style="color: #fd7e14;">~5 Spontan√©s</div>
                <div class="stat-label">Candidatures Libres</div>
            </div>
        </div>

        <p style="font-size: 0.9rem; color: #888; font-style: italic;">
            <i class="fas fa-info-circle"></i> Les CVs PDF sont g√©n√©r√©s dynamiquement avec des mots-cl√©s pertinents pour
            garantir le scoring IA.
        </p>

        <button id="start-btn" class="btn" onclick="startAdvancedSeeding()">üöÄ Lancer la Simulation Compl√®te</button>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="logs" class="log-area"></div>

        <a href="admin_dashboard.html" id="done-link"
            style="display: none; margin-top: 25px; color: #0056B3; text-decoration: none; font-weight: bold; font-size: 1.1rem;">
            Voir le Tableau de Bord &rarr;
        </a>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-t9SJSfBZt3-5BU_N5yWehDPexStI859IeM-8SIQUS5VHFMz-s9Jl99HdhEesRB8w/exec";
        const { jsPDF } = window.jspdf;

        // Data Pools
        const names = {
            fr: ["Thomas", "Lucas", "L√©a", "Manon", "Camille", "Hugo", "Chlo√©", "Nathan"],
            ma: ["Ahmed", "Karim", "Fatima", "Youssef", "Khadija", "Omar", "Amina", "Rachid", "Leila", "Driss"],
            last: ["Benali", "Dubois", "Martin", "Alaoui", "Bernard", "Tazi", "Petit", "Idrissi", "Robert", "Mansouri"]
        };

        const mismatchKeywords = "Recette Cuisine Chef P√¢tisserie Sport Football Musique Piano Voyage Jardinage Peinture Histoire G√©ographie";

        function log(msg, type = 'info') {
            const area = document.getElementById('logs');
            area.style.display = 'block';

            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function generatePDF(text) {
            const doc = new jsPDF();
            // Split text to fit page
            const splitText = doc.splitTextToSize(text, 180);
            doc.text(splitText, 10, 10);
            return doc.output('datauristring').split(',')[1]; // Return Base64 only
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        async function startAdvancedSeeding() {
            const btn = document.getElementById('start-btn');
            const bar = document.getElementById('progress-bar');
            document.getElementById('progress-container').style.display = 'block';
            btn.disabled = true;

            try {
                // 1. Fetch Offers
                log("R√©cup√©ration des offres actives...", 'info');
                const resp = await fetch(GOOGLE_SCRIPT_URL + '?action=getOffers');
                const offers = await resp.json();

                log(`${offers.length} offres trouv√©es. D√©marrage de la g√©n√©ration...`, 'success');

                const totalTasks = (offers.length * 2) + 5; // 2 per offer + 5 spontaneous
                let completed = 0;

                // 2. Process Offers (Perfect & Mismatch Candidates)
                for (const offer of offers) {
                    // A. Perfect Match
                    await createCandidate(offer, true);
                    updateProgress(++completed, totalTasks);

                    // B. Mismatch
                    await createCandidate(offer, false);
                    updateProgress(++completed, totalTasks);
                }

                // 3. Spontaneous Applications
                for (let i = 0; i < 5; i++) {
                    await createSpontaneous();
                    updateProgress(++completed, totalTasks);
                }

                log("Termin√© ! Toutes les candidatures ont √©t√© envoy√©es.", 'success');
                btn.textContent = "‚úÖ G√©n√©ration Termin√©e";
                document.getElementById('done-link').style.display = 'inline-block';

            } catch (e) {
                log("Erreur critique: " + e.message, 'error');
                btn.disabled = false;
            }
        }

        async function createCandidate(offer, isPerfect) {
            const fname = getRandomItem(names.ma);
            const lname = getRandomItem(names.last);

            // Context-aware Resume Text
            let cvText = `CV DE ${fname.toUpperCase()} ${lname.toUpperCase()}\n\n`;
            if (isPerfect) {
                cvText += `PROFIL:\nExpert en ${offer.title}.\n\nEXP√âRIENCE:\nJ'ai travaill√© comme ${offer.title} pendant 5 ans.\n\nCOMP√âTENCES:\n${offer.desc}\n\nVILLE:\n${offer.location}\n\nCONTRAT:\nDisponible pour ${offer.contract}.`;
            } else {
                cvText += `PROFIL:\nPassionn√© de cuisine.\n\nEXP√âRIENCE:\nChef Cuisinier (3 ans).\n\nCOMP√âTENCES:\n${mismatchKeywords}\n\nVILLE:\nTombouctou\n\nCONTRAT:\nCDD uniquement.`;
            }

            const payload = {
                action: 'candidate',
                nom: lname,
                prenom: fname,
                email: `${fname}.${lname}.${Math.floor(Math.random() * 1000)}@test.com`.toLowerCase(),
                phone: "06" + Math.floor(Math.random() * 90000000 + 10000000),
                ville: isPerfect ? offer.location : "Autre",
                niveau: isPerfect ? offer.level : "Bac",
                experience: isPerfect ? offer.exp : "D√©butant",
                contrat: isPerfect ? offer.contract : "Stage",
                poste: offer.title, // Must match exactly for 'candidate' action
                cvBase64: generatePDF(cvText),
                cvFileName: `CV_${lname}_${fname}_${isPerfect ? 'Match' : 'Mismatch'}.pdf`,
                mimeType: "application/pdf"
            };

            log(`Envoi: ${fname} ${lname} -> ${offer.title} (${isPerfect ? '‚≠ê‚≠ê‚≠ê' : '‚≠ê'})`);
            await sendData(payload);
        }

        async function createSpontaneous() {
            const fname = getRandomItem(names.fr);
            const lname = getRandomItem(names.last);

            const cvText = `CV SPONTAN√â\n\nJe cherche un poste dans la banque.\nComp√©tences: Finance, Accueil, Gestion.`;

            const payload = {
                action: 'spontaneous_application',
                nom: lname,
                prenom: fname,
                email: `spontanee.${fname}@test.com`.toLowerCase(),
                phone: "06" + Math.floor(Math.random() * 90000000 + 10000000),
                ville: getRandomItem(["Casablanca", "Rabat", "Marrakech"]),
                niveau: "Bac+5",
                experience: "3 ans",
                contrat: "CDI",
                cvBase64: generatePDF(cvText),
                cvFileName: `CV_Spontane_${lname}.pdf`,
                mimeType: "application/pdf"
            };

            log(`Envoi Spontan√©: ${fname} ${lname}`);
            await sendData(payload);
        }

        async function sendData(payload) {
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // text/plain avoids OPTIONS preflight which GAS doesn't like
                    body: JSON.stringify(payload)
                });
                // Small delay to prevent quota limits
                await new Promise(r => setTimeout(r, 1200));
            } catch (e) {
                log("Erreur r√©seau: " + e.message, 'error');
            }
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100);
            document.getElementById('progress-bar').style.width = pct + "%";
        }
    </script>
</body>

</html>